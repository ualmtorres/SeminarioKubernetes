<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.5.dev">
<meta name="author" content="Cloud-DI Team - Departamento de Informática. UAL">
<title>Kubernetes</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
body{-webkit-font-smoothing:antialiased}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
body{tab-size:4}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-right">
<div id="header">
<h1>Kubernetes</h1>
<div class="details">
<span id="author" class="author">Cloud-DI Team - Departamento de Informática. UAL</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Tabla de contenidos</div>
<ul class="sectlevel1">
<li><a href="#trueresumen">Resumen</a></li>
<li><a href="#trueintroducci-n">1. Introducción</a></li>
<li><a href="#trueconceptos-b-sicos">2. Conceptos básicos</a>
<ul class="sectlevel2">
<li><a href="#truecluster-de-kubernetes">2.1. Cluster de Kubernetes</a></li>
<li><a href="#truearquitectura-de-kubernetes">2.2. Arquitectura de Kubernetes</a></li>
<li><a href="#trueobjetos-de-kubernetes">2.3. Objetos de Kubernetes</a></li>
</ul>
</li>
<li><a href="#Minikube">3. Minikube</a></li>
<li><a href="#true-code-kubectl-code-el-cli-para-kubernetes">4. <code>kubectl</code> el CLI para Kubernetes</a></li>
<li><a href="#truecomponentes-de-kubernetes-en-acci-n">5. Componentes de Kubernetes en acción</a>
<ul class="sectlevel2">
<li><a href="#truedeployments">5.1. Deployments</a></li>
<li><a href="#truepods">5.2. Pods</a></li>
<li><a href="#truenodos">5.3. Nodos</a></li>
<li><a href="#trueservicios">5.4. Servicios</a></li>
<li><a href="#truevol-menes">5.5. Volúmenes</a></li>
<li><a href="#truenamespaces">5.6. Namespaces</a></li>
</ul>
</li>
<li><a href="#trueescalado-de-una-aplicaci-n">6. Escalado de una aplicación</a>
<ul class="sectlevel2">
<li><a href="#trueejemplo-de-escalado-de-una-aplicaci-n">6.1. Ejemplo de escalado de una aplicación</a></li>
</ul>
</li>
<li><a href="#trueactualizaci-n-de-aplicaciones">7. Actualización de aplicaciones</a></li>
<li><a href="#truedespliegue-de-aplicaciones-mediante-archivos-yaml">8. Despliegue de aplicaciones mediante archivos YAML</a>
<ul class="sectlevel2">
<li><a href="#truecreaci-n-del-archivo-de-deployment">8.1. Creación del archivo de Deployment</a></li>
<li><a href="#truecreaci-n-del-archivo-de-servicio">8.2. Creación del archivo de Servicio</a></li>
</ul>
</li>
<li><a href="#trueap-ndice-cheat-sheet">9. Apéndice. Cheat Sheet</a>
<ul class="sectlevel2">
<li><a href="#truecomandos-minikube">9.1. Comandos Minikube</a></li>
<li><a href="#truecomandos-code-kubectl-code">9.2. Comandos <code>kubectl</code></a></li>
<li><a href="#truecontextos">9.3. Contextos</a></li>
</ul>
</li>
<li><a href="#trueap-ndice-service-mesh-con-istio">10. Apéndice. Service Mesh con Istio</a>
<ul class="sectlevel2">
<li><a href="#trueistio">10.1. Istio</a></li>
<li><a href="#truearquitectura-de-istio">10.2. Arquitectura de Istio</a></li>
<li><a href="#truecontrol-de-tr-fico-y-t-cnicas-de-despliegue">10.3. Control de tráfico y técnicas de despliegue</a></li>
<li><a href="#truet-cnicas-de-resilencia">10.4. Técnicas de resilencia</a></li>
<li><a href="#truecaso-pr-ctico">10.5. Caso práctico</a></li>
<li><a href="#truecasos-pr-cticos">10.6. Casos prácticos</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="./images/di.png" alt="di.png">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueresumen"><a class="anchor" href="#trueresumen"></a>Resumen</h2>
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>TRABAJO EN CURSO</strong></p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Objetivos</div>
<ul>
<li>
<p>Conocer la importancia del uso de Kubernetes en el ciclo de vida de las aplicaciones actuales.</p>
</li>
<li>
<p>Introducir los conceptos básicos de Kubernetes.</p>
</li>
<li>
<p>Usar Minikube para el desarrollo y prueba en local.</p>
</li>
<li>
<p>Usar <code>kubectl</code> para la administración básica de Kubernetes.</p>
</li>
<li>
<p>Escalar aplicaciones.</p>
</li>
<li>
<p>Realizar actualizaciones en caliente (<em>rolling updates</em>).</p>
</li>
<li>
<p>Desplegar aplicaciones con archivos YAML.</p>
</li>
<li>
<p>Aprender a usar Kubernetes Dashboard.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Disponibles los repositorios usados en este seminario:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/ualmtorres/json-producer">Código fuente de JSON Producer</a></p>
</li>
<li>
<p><a href="https://github.com/ualmtorres/json-reader">Código fuente de JSON Reader</a></p>
</li>
<li>
<p><a href="https://github.com/ualmtorres/jsonproducerreader">Archivos YAML de JSON Producer y Reader</a></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueintroducci-n"><a class="anchor" href="#trueintroducci-n"></a>1. Introducción</h2>
<div class="sectionbody">
<div class="paragraph">
<p>La adopción de Docker sigue creciendo de forma imparable y cada vez más organizaciones lo usan en producción. Por tanto, se hace necesario contar con una plataforma de orquestación que permita administrar y escalar los contenedores.</p>
</div>
<div class="paragraph">
<p>Supongamos que hemos comenzado a usar Docker y hemos hecho un despliegue de un par de servidores. De pronto, la aplicación comienza a tener un gran tráfico de entrada y hay que escalar a una gran cantidad de servidores para atender la demanda. Aquí es donde entra Kubernetes para hacer tareas del tipo <em>dónde debe ir un contenedor, cómo se monitorizan esos contenedores</em> o <em>cómo se reinician cuando tengan un problema</em>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueconceptos-b-sicos"><a class="anchor" href="#trueconceptos-b-sicos"></a>2. Conceptos básicos</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Kubernetes es una plataforma de código abierto para despliegue automático, escalado y gestión de aplicaciones contenedorizadas.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Kubernetes is a portable, extensible, open-source platform for managing containerized workloads and services, that facilitates both declarative configuration and automation. It has a large, rapidly growing ecosystem. Kubernetes services, support, and tools are widely available.</p>
</div>
<div class="paragraph">
<p>The name Kubernetes originates from Greek, meaning helmsman or pilot. Google open-sourced the Kubernetes project in 2014. Kubernetes builds upon a decade and a half of experience that Google has with running production workloads at scale, combined with best-of-breed ideas and practices from the community.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Documentación oficial de Kubernetes (https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/)
</div>
</div>
<div class="paragraph">
<p>Kubernetes ofrece una abstracción en la que permite el despliegue de aplicaciones en un cluster sin pensar en las máquinas que lo soportan.</p>
</div>
<div class="sect2">
<h3 id="truecluster-de-kubernetes"><a class="anchor" href="#truecluster-de-kubernetes"></a>2.1. Cluster de Kubernetes</h3>
<div class="paragraph">
<p>Un cluster de Kubernetes está formado por dos tipos de recursos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>El <strong>Master</strong> coordina el cluster. Coordina todas las actividades del cluster como organizar (schedule) las aplicaciones, mantener el estado deseado de las aplicaciones, escalado, despliegue de actualizaciones, y demás. También recoge información de los nodos worker y Pods.</p>
</li>
<li>
<p>Los <strong>Nodos</strong> son <em>workers</em> que ejecutan las aplicaciones. Cada nodo contiene un agente denominado <em>Kubelet</em> que gestiona el nodo y mantiene la comunicación con el Máster. El nodo también tiene herramientas para trabajar con contenedores, como Docker.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Un cluster Kubernetes en producción debería tener al menos 3 nodos. En entornos de producción se usan varios nodos máster para que los clusters sean tolerantes a fallos y ofrezcan alta disponibilidad.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/KubernetesCluster.svg" alt="KubernetesCluster.svg">
</div>
</div>
<div class="paragraph">
<p>Al desplegar una aplicación en Kubernetes el Master inicia los contenedores de la aplicación. El máster organiza los contenedores para que se ejecuten en los nodos del cluster. Los nodos se comunican con el master usando la <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.15/#-strong-api-overview-strong-">API de Kubernetes</a>. La API es expuesta a través del nodo Master y es posible usarla directamente para intectuar con el cluster.</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. Lista de pods usando la API de Kubernetes</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ curl http://&lt;kubernetes_home&gt;/api/v1/namespaces/default/pods</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json" data-lang="json">{
  "kind": "PodList",
  "apiVersion": "v1",
  "metadata": {
    "selfLink": "/api/v1/namespaces/default/pods",
    "resourceVersion": "10803"
  },
  "items": [
    {
      "metadata": {
        "name": "hello-minikube-64c7df9db-ffwtn",
        "generateName": "hello-minikube-64c7df9db-",
        "namespace": "default",
        "selfLink": "/api/v1/namespaces/default/pods/hello-minikube-64c7df9db-ffwtn",
        "uid": "652c298a-6dc2-4aec-a72f-390669fed6d2",
        "resourceVersion": "10608",
        "creationTimestamp": "2019-07-08T18:02:23Z",
        "labels": {
          "pod-template-hash": "64c7df9db",
          "run": "hello-minikube"
        },
....</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Los clusters de Kubernetes se pueden desplegar sobre máquinas físicas o virtuales. Para comenzar a practicar con Kubernetes o para tareas de desarrollo, <a href="https://github.com/kubernetes/minikube">Minikube</a> es una buena opción. En la sección <a href="#Minikube">Minikube</a> se presenta más información sobre esta plataforma. Minikube está disponible para Windows, Linux y MacOS.</p>
</div>
</div>
<div class="sect2">
<h3 id="truearquitectura-de-kubernetes"><a class="anchor" href="#truearquitectura-de-kubernetes"></a>2.2. Arquitectura de Kubernetes</h3>
<div class="paragraph">
<p>Tal y como hemos introducido en el apartado anterior, un cluster de Kubernetes está formado por dos tipos de unidades, el nodo <em>Master</em> y los nodos <em>Worker</em> (o siemplemente <em>Nodos</em>).</p>
</div>
<div class="paragraph">
<p>La figura siguiente ilustra estas dos unidades, así como algunos de los componentes más importantes en su interior.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/KubernetesArchitecture.png" alt="KubernetesArchitecture.png">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Plugins de red: Permite la conexión entre pods de nodos diferentes y la integración de soluciones de red diferentes (overlay, L3, &#8230;&#8203;)</p>
</li>
<li>
<p><code>etcd</code>: una base de datos clave-valor donde Kubernetes guarda todos los datos del cluster.</p>
</li>
<li>
<p>API server: Componente del Master que expone la API de Kubernetes. Es el front-end del plano de control de Kubernetes.</p>
</li>
<li>
<p>Control Manager: Se encarga de comprobar si el estado deseado coincide con la realidad (p.e. número de réplicas)</p>
</li>
<li>
<p>Scheduler: Componente del master que observa qué pods se han creado nuevos y no tienen nodo asignado, y les selecciona un nodo donde se puedan ejecutar.</p>
</li>
<li>
<p><code>kubelet</code>: Agente que se se ejecuta en cada nodo worker del cluster y que asegura que los nodos están en ejecución y sanos. <strong><code>kubelet</code> no gestiona los pods que no han sido creados por Kubernetes.</strong></p>
</li>
<li>
<p><code>kube-proxy</code>: Mantiene las reglas de networking en los nodos para los pods que se ejecutan en él de acuerdo con las especificaciones de los manifiestos.</p>
</li>
<li>
<p><code>cAdvisor</code>: Recoge datos de uso de los contenedores.</p>
</li>
<li>
<p>Plano de control o <em>Control plane</em>: Nivel de orquestación de contenedores que expone la API para definir, desplegar y gestionar el ciclo de vida de los contenedores.</p>
</li>
<li>
<p>Plano de datos o <em>Data Plane</em>: Nivel que proporciona los recursos, como CPU. memoria, red y almacenamiento, para que los pods se puedan ejecutar y conectar a la red.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="https://etcd.io/">etcd</a>, es una base de datos clave-valor fiable y distribiuda para los datos más críticos de un un sistema distribuido. Dado que Kubernetes guarda todos los datos del cluster en ella, se deberían mantener copias de seguridad de esta base de datos y disponer de un plan de recuperación ante posibles desastres.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Los componentes <code>kube-proxy</code>, <code>kube-scheduler</code>, <code>kube-controller-manager</code>, <code>etcd</code>, <code>kubelet</code>, así como los componentes de red se eejcutan como contenedores en cada uno de los nodos del cluster de Kubernetes. Basta con abrir un terminal en uno de los nodos del cluster y comprobarlo. Si lo hacemos, veremos como en los nodos worker están los contenedores de los componentes de Kubernetes junto con los contenedores de las aplicaciones que se están ejecutando en el nodo.</p>
</div>
<div class="paragraph">
<p>Un ejercicio interesante es detener el contenedor <code>kubelet</code> y ver cómo el nodo pasa a estar inactivo. En caso de ser el único nodo de trabajo, los contenedores de los nuevos despliegues quedarán en el estado <code>Pending</code> mientras <code>kubelet</code> no vuelva a estar disponible.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="trueobjetos-de-kubernetes"><a class="anchor" href="#trueobjetos-de-kubernetes"></a>2.3. Objetos de Kubernetes</h3>
<div class="paragraph">
<p>Kubernetes ofrece una serie de objetos básicos y una serie de abstracciones de nivel superior llamadas Controladores. Los Controladores se basan en los objetos básicos y proporcionan funcionalidades adicionales sobre los objetos básicos</p>
</div>
<div class="paragraph">
<p>Los objetos básicos de Kubernetes son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Pod</p>
</li>
<li>
<p>Service</p>
</li>
<li>
<p>Volume</p>
</li>
<li>
<p>Namespace</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Los objetos de nivel superior o Controladores se basan en los objetos básicos y ofrecen funcionalidades adicionales sobre los objetos básicos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ReplicaSet</p>
</li>
<li>
<p>Deployment</p>
</li>
<li>
<p>StatefulSet</p>
</li>
<li>
<p>DaemonSet</p>
</li>
<li>
<p>Job</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Minikube"><a class="anchor" href="#Minikube"></a>3. Minikube</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Minikube es una implementación ligera de Kubernetes que crea una máquina virtual localmente y despliega un cluster sencillo formado por un solo nodo.</p>
</li>
<li>
<p>Minikube es una gran herramienta para el desarrollo de aplicaciones Kubernetes y permite características habituales como <em>LoadBalancer</em>, <em>NodePort</em>, volúmenes persistentes, <em>Ingress</em>, dashboard, reglas de acceso, y demás.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>En la <a href="https://github.com/kubernetes/minikube">página de GitHub de Minikube</a> se encuentra información sobre el proyecto, <a href="https://kubernetes.io/docs/tasks/tools/install-minikube/">instalación</a> y otros temas de interés.</p>
</div>
<div class="paragraph">
<p>Una vez instalado, probaremos los comandos básicos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Iniciar un cluster: <code>minikube start</code> (La primera vez que ejecutemos este comando descargará la ISO de Minikube, que son unos 130 MB, y creará la máquina virtual correspondiente)</p>
</li>
<li>
<p>Acceso al Dashboard de Kubernetes: <code>minikube dashboard</code></p>
</li>
<li>
<p>Una vez iniciado, se podrá interactuar con el cluster usando <code>kubectl</code> (que veremos en la sección <a href="#kubectl el CLI para Kubernetes">[kubectl el CLI para Kubernetes]</a>) como con cualquier cluster Kubernetes:</p>
<div class="ulist">
<ul>
<li>
<p>Iniciar un servidor: <code>kubectl run hello-minikube --image=k8s.gcr.io/echoserver:1.4 --port=8080</code></p>
</li>
<li>
<p>Exponer un servicio como un <em>NodePort</em>: <code>kubectl expose deployment hello-minikube --type=NodePort</code></p>
</li>
<li>
<p>Abrir el endpoint del servicio en el navegador: <code>minikube service hello-minikube</code></p>
<div class="paragraph">
<p>El servidor de ejemplo iniciado muestra información sobre el cliente en el que se está ejecutando y sobre las cabeceras. Dicho servidor es expuesto en el cluster de Kubernetes como un <em>NodePort</em>. El resultado tras mostrarlo con <code>minikube service hello-minikube</code> será algo similar al de la figura siguiente.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/SampleKubernetesService.png" alt="SampleKubernetesService.png">
</div>
</div>
<div class="paragraph">
<p>Si ahora abrimos el dashboard, se mostraría algo similar a lo de la figura siguiente. En la figura se observa cómo ha sido creado el Deployment <code>hello-minikube</code>.</p>
</div>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/KubernetesDashboard.png" alt="KubernetesDashboard.png">
</div>
</div>
</li>
<li>
<p>Iniciar un segundo cluster local: <code>minikube start -p cluster2</code></p>
</li>
<li>
<p>Detener el cluster local: <code>minikube stop</code></p>
</li>
<li>
<p>Eliminar el cluster local: <code>minikube delete</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="true-code-kubectl-code-el-cli-para-kubernetes"><a class="anchor" href="#true-code-kubectl-code-el-cli-para-kubernetes"></a>4. <code>kubectl</code> el CLI para Kubernetes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Para la interacción con un cluster local o remoto de Kubernetes mediante comandos se usa <code>kubectl</code>, un CLI sencillo que nos permitirá realizar tareas habituales como despliegues, escalar el cluster u obtener información sobre los servicios en ejecución. <code>kubectl</code> es el CLI para interactuar con el servidor de la API de Kubernetes.</p>
</div>
<div class="paragraph">
<p>Consultar la <a href="https://kubernetes.io/es/docs/tasks/tools/install-kubectl/#instalar-kubectl">página oficial de instalación y configuración de <code>kubectl</code></a></p>
</div>
<div class="paragraph">
<p>Para interactuar con unos ejemplos sencillo con <code>kubectl</code> podemos</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Obtener información de la versión</p>
</li>
<li>
<p>Obtener información del cluster</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl cluster-info
Kubernetes master is running at https://192.168.99.100:8443
KubeDNS is running at https://192.168.99.100:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</code></pre>
</div>
</div>
</li>
<li>
<p>Obtener los nodos que forman el cluster</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl get nodes
NAME       STATUS   ROLES    AGE     VERSION
minikube   Ready    master   3d23h   v1.15.0</code></pre>
</div>
</div>
</li>
<li>
<p>Otras operaciones de interés son:</p>
<div class="ulist">
<ul>
<li>
<p><code>kubectl describe &lt;resource&gt;</code> para obtener información detallada sobre un recurso.</p>
</li>
<li>
<p><code>kubectl logs &lt;pod&gt;</code> para mostrar los logs de un contenedor en un pod.</p>
</li>
<li>
<p><code>kubectl exec &lt;pod&gt; &lt;command&gt;</code> para ejecutar un comando en un contenedor de un pod.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truecomponentes-de-kubernetes-en-acci-n"><a class="anchor" href="#truecomponentes-de-kubernetes-en-acci-n"></a>5. Componentes de Kubernetes en acción</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="truedeployments"><a class="anchor" href="#truedeployments"></a>5.1. Deployments</h3>
<div class="paragraph">
<p>Una configuración de Deployment pide a Kubernetes que cree y actualice las instancias de una aplicación. Tras crear el Deployment, el Master organiza las instancias de aplicación en los nodos disponibles del cluster.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/KubernetesDeployment.svg" alt="KubernetesDeployment.svg">
</div>
</div>
<div class="paragraph">
<p>Una vez creadas las instancias de aplicación, el <strong>Controlador de Deployment de Kubernetes</strong> monitoriza continuamente las instancias. Si un nodo en el que está una instancia cae o es eliminado, el Controlador de Deployment de Kubernetes sustituye la instancia por otra instancia en otro nodo disponible del cluster.</p>
</div>
<div class="paragraph">
<p>Esta funcionalidad de <em>autocuración</em> de las aplicaciones supone un cambio radical en la gestión de las aplicaciones. Esta característica de recuperación de fallos mediante la creación de nuevas instancias que reemplazan a las defectuosas o desaparecidas no existía antes de los orquestadores.</p>
</div>
<div class="paragraph">
<p>Al crear un Deployment se especifica la imagen del contenedor que usará la aplicación y el número de réplicas que se quieren mantener en ejecución. El número de réplicas se puede modificar en cualquier momento actualizando el Deployment.</p>
</div>
<div class="sect3">
<h4 id="truedespliegue-de-una-aplicaci-n"><a class="anchor" href="#truedespliegue-de-una-aplicaci-n"></a>5.1.1. Despliegue de una aplicación</h4>
<div class="paragraph">
<p>Podemos ejecutar una aplicación con <code>kubectl run</code> indicando el nombre que se dará al Deployment y el nombre de la imagen (Docker) usada para la aplicación.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl run jsonproducer --image=ualmtorres/jsonproducer:v0 --port 80 <i class="conum" data-value="1"></i><b>(1)</b>

deployment.apps/jsonproducer created</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>El puerto hace referencia al puerto que usa la aplicación original para servir su contenido.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Esto ha hecho que el Master haya buscado un nodo para ejecutar la aplicación, haya programado la ejecución de la aplicación en ese nodo y haya configurado el cluster para programar la ejecución de otra instancia cuando sea necesario.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Para imágenes que no estén en Docker Hub se pasa la URL completa del repositorio de imágenes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para obtener los Deployments disponibles</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl get deployments

NAME           READY   UP-TO-DATE   AVAILABLE   AGE
jsonproducer   1/1     1            1           8s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para poder acceder a la aplicación deberemos primero exponerla en el cluster de Kubernetes. Más adelante veremos los detalles. Por ahora, basta con ejecutar el comando siguiente, el cual creará un <em>servicio</em> asociado a nuestro Deployment para poder acceder a la aplicación.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl expose deployment jsonproducer --type=NodePort

service/jsonproducer exposed</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para ver la ejecución de la aplicación, pediremos a Minikube que nos muestre el <em>servicio</em> con el comando</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ minikube service jsonproducer</code></pre>
</div>
</div>
<div class="paragraph">
<p>Esto abrirá un navegador y el resultado del servicio es un JSON similar a este:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json" data-lang="json">{"nombre":"manolo"}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truepods"><a class="anchor" href="#truepods"></a>5.2. Pods</h3>
<div class="paragraph">
<p>Al crear el Deployment anterior, Kubernetes creó un Pod para ejecutar una instancia de la aplicación. Un Pod es una abstracción de Kubernetes que representa un grupo de uno o más contenedores de una aplicación y algunos recursos compartidos de esos contenedores (p.e. volúmenes, redes)</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Un ejemplo de pod con más de un contenedor lo encontramos en lo que se denominan <em>sidecars</em>. Ejemplos de sidecar los encontramos en aplicaciones que registran su actividad en un contenedor (sidecar) dentro del mismo pod y publican la actividad en una aplicación que monitoriza el cluster. Otro ejemplo de sidecar es el de un contenedor sidecar que proporciona un certificado SSL para comunicación https al contenedor de la aplicación.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Los contenedores de un pod comparten una IP y un espacio de puertos, y siempre van juntos y se despliegan juntos en un nodo. La figura siguiente ilustra varias configuraciones de pods: Un pod con un contenedor, un pod con un contenedor y un volumen, un pod con dos contenedores que comparten un volumen y un pod con varios contenedores y varios volúmenes.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/KubernetesPod.svg" alt="KubernetesPod.svg">
</div>
</div>
<div class="paragraph">
<p>Los pods son la unidad atómica de Kubernetes. Al crear un despliegue en Kubernetes, el Deployment crea Pods con contenedores en su interior. Cada pod queda ligado a un nodo y sigue allí hasta que se finalice o se elimine. En caso de fallo del nodo se planifica la creación de sus pods en otros nodos disponibles del cluster. <strong>Los pods son efímeros, por lo que su almacenamiento desaparece al eliminar el pod</strong>. Por este motivo es necesario saber utilizar almacenamiento externo para que los datos persistan. El almacenamiento se tratará en otra sección de este tutorial.</p>
</div>
<div class="paragraph">
<div class="title">Creación de un pod para MongoDB</div>
<p>Los pods, al igual que otros recursos de Kubernetes (replicasets, volúmenes, &#8230;&#8203;) se pueden crear sobre la marcha con el CLI indicando la imagen a partir de la que se crean, o se pueden crear a partir de archivos de manifiesto. Estos archivos de manifiesto se escriben en sintaxis <a href="https://yaml.org/">YAML</a> y representan una forma declarativa de definir los recursos del cluster Kubernetes.</p>
</div>
<div class="paragraph">
<p>Para ilustrar cómo crear un pod, veremos cómo crear uno sencillo para MongoDB a partir de un archivo de manifiesto. Para ir familiriarizándonos con Kubernetes, probaremos también con unos comandos básicos para mostrar información, mostrar los logs, redirección de puertos</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Creación del manifiesto YAML</p>
<div class="paragraph">
<p>Archivo <code>mongodb-basico.yaml</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Pod
metadata:
  name: mongodb
spec:
  containers:
  - image: mongo
    name: mongodb</code></pre>
</div>
</div>
</li>
<li>
<p>Despliegue del manifiesto para crear el pod</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl apply -f mongodb-basico.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Inicio de sesión SSH en el pod</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl exec -it mongodb /bin/bash</code></pre>
</div>
</div>
</li>
<li>
<p>Mostrar información del pod</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl describe pod mongodb</code></pre>
</div>
</div>
</li>
<li>
<p>Mostrar los logs del pod</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl logs mongodb</code></pre>
</div>
</div>
</li>
<li>
<p>Redirección del puerto del pod a un puerto local (establece un túnel SSH entre nuestro equipo y el pod con los puertos indicados)</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl port-forward mongodb 27017:27017</code></pre>
</div>
</div>
</li>
<li>
<p>Eliminación del pod</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl delete -f mongodb-basico.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="truenodos"><a class="anchor" href="#truenodos"></a>5.3. Nodos</h3>
<div class="paragraph">
<p>Los pods se ejecutan en un Nodo. Un nodo es una máquina <em>worker</em> (física o virtual) del cluster. Los nodos están gestionados por el Master. Un Nodo puede contener muchos pods.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/KubernetesNode.svg" alt="KubernetesNode.svg">
</div>
</div>
<div class="paragraph">
<p>Cada Nodo ejecuta al menos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Kubelet, un proceso que se encarga de la comunicación entre el nodo y el Master. Gestiona los pods y los contenedores que se están ejecutando en el nodo.</p>
</li>
<li>
<p>Un motor de contenedores, como Docker, que se encarga de la descarga de imágenes de un registro y de ejecutar la aplicación.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="trueservicios"><a class="anchor" href="#trueservicios"></a>5.4. Servicios</h3>
<div class="paragraph">
<p>Se dice que en Kubernetes los pods son mortales o efímeros. Cuando un nodo desaparece (bien por un error o por una desconexión), los contenedores que están en el nodo también se pierden. A continuación, un <em>ReplicaSet</em> se encarga de devolver al cluster al estado deseado y organiza la creación de nuevos pods en otros nodos disponibles para mantener funcionando la aplicación. Las réplicas de los pods han de ser intercambiables y <strong>aunque cada pod en el cluster tenga su propia IP única, Kubernetes reconcialiará los cambios entre los pods para que las aplicaciones sigan funcionando</strong>.</p>
</div>
<div class="paragraph">
<p>Los servicios en Kubernetes son una abstracción que definen un conjunto lógico de pods y una política de acceso a ellos estableciendo un nombre para acceder a ellos. Esto permite que haya un acoplamiento débil entre pods dependientes. El acceso puede ser interno o externo al cluster. De esta forma, las aplicaciones sólo usarán los nombres de los servicios y no las IP de los pods, ya que éstas nunca son fijas debido a que, por un lado, los pods se crean y se destruyen para mantener el número de réplicas deseado; y por otro lado, un pod puede ser sustituido por otro ante un problema y el nuevo pod tendrá una IP diferente.</p>
</div>
<div class="paragraph">
<p>Cada pod tiene una dirección IP única, pero esa IP no se expone fuera del cluster sin lo que se denomina un Servicio. Los servicios pemiten que las aplicaciones reciban tráfico. En función del ámbito de la exposición del servicio tenemos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ClusterIP: El servicio recibe una IP interna a nivel de cluster y hace que el servicio sólo sea accesible a nivel de cluster.</p>
</li>
<li>
<p>NodePort: Expone el servicio fuera del cluster concatenando la IP del nodo en el que está el pod y un número de puerto entre 30000 y 32767, que es el mismo en todos los nodos</p>
</li>
<li>
<p>LoadBalancer: Crea en cloud, si es posible, un balanceador externo con una IP externa asignada.</p>
</li>
<li>
<p>ExternalName: Expone el servicio usando un nombre arbitrario (especificado en <code>externalName</code>)</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/KubernetesService.svg" alt="KubernetesService.svg">
</div>
</div>
<div class="paragraph">
<p>Los servicios enrutan el tráfico entre los pods proporcionando una abstracción que permite que los pod mueran y se repliquen sin impactar en la aplicación. El descubrimiento y enrutado entre pods dependientes (p.e. frontend y backend) son gestionados por los Servicios.</p>
</div>
<div class="paragraph">
<p>Los servicios agrupan a sus pods usando etiquetas y selectores. Las etiquetas son pares clave-valor y tienen usos muy variados:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Diferenciar entre objetos de desarrollo, prueba y producción</p>
</li>
<li>
<p>Distinguir entre versiones</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/KubernetesLabels.svg" alt="KubernetesLabels.svg">
</div>
</div>
<div class="paragraph">
<p>En la figura se observa cómo el selector de etiquetas usado en los Deployment sirve para agrupar los pods que conforman un servicio, ya que cada pod contiene la misma etiqueta usada en el selector del Deployment al que pertenece.</p>
</div>
<div class="paragraph">
<p>Las etiquetas se pueden configurar durante la creación o en cualquier momento posterior.</p>
</div>
<div class="sect3">
<h4 id="trueejemplo-creaci-n-de-un-servicio"><a class="anchor" href="#trueejemplo-creaci-n-de-un-servicio"></a>5.4.1. Ejemplo. Creación de un servicio</h4>
<div class="paragraph">
<p>Anteriormente, en la sección <a href="#truedespliegue-de-una-aplicaci-n">Despliegue de una aplicación</a> creamos una aplicación de ejemplo que generaba un JSON de prueba. A modo de recordatorio, hicimos lo siguiente:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crear un Deployment a partir de la imagen <code>ualmtorres/jsonproducer:v0</code> de Docker Hub con el comando</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl run jsonproducer --image=ualmtorres/jsonproducer:v0 --port 80</code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos consultar el Deployment existente con el comando siguiente. Si por cualquier motivo no se dispone del Deployment, basta con ejecutar el comando anterior para crearlo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json" data-lang="json">$ kubectl get deployments
NAME           READY   UP-TO-DATE   AVAILABLE   AGE
jsonproducer   1/1     1            1           17m</code></pre>
</div>
</div>
<div class="paragraph">
<p>Este Deployment habrá creado un pod que estará ejecutando la aplicación disponible de la imagen utilizada. Podemos ver los pods disponibles con el comando</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl get pods
NAME                            READY   STATUS    RESTARTS   AGE
jsonproducer-7769d76894-2nzt2   1/1     Running   0          23m</code></pre>
</div>
</div>
</li>
<li>
<p>Crear un servicio para poder exponer la aplicación al exterior. Concretamente usamos un servicio de tipo NodePort, lo que nos sirve la aplicación concatenando la IP del nodo donde está el pod y un puerto aleatorio. El servicio lo creamos con</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl expose deployment jsonproducer --type=NodePort</code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos consultar el servicio existente con el comando siguiente. Si por cualquier motivo no se dispone del servicio, basta con ejecutar el comando anterior para crearlo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl get services
NAME           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
jsonproducer   NodePort    10.99.116.165   &lt;none&gt;        80:30737/TCP   25m <i class="conum" data-value="1"></i><b>(1)</b>
kubernetes     ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP        34d <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Este es nuestro servicio. En el caso del tutorial, el puerto aleatorio asignado es el 30737</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Servicio <code>kubernetes</code> creado de forma predetermianda al iniciarse Minikube</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Podemos acceder el servicio creado con</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ minikube service jsonproducer</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/KubernetesRunningService.png" alt="KubernetesRunningService.png">
</div>
</div>
<div class="paragraph">
<p>Si queremos consultar la información del servicio creado usaremos la opción <code>describe</code> de <code>kubectl</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl describe services jsonproducer <i class="conum" data-value="1"></i><b>(1)</b>

Name:                     jsonproducer
Namespace:                default
Labels:                   run=jsonproducer <i class="conum" data-value="2"></i><b>(2)</b>
Annotations:              &lt;none&gt;
Selector:                 run=jsonproducer
Type:                     NodePort
IP:                       10.99.116.165
Port:                     &lt;unset&gt;  80/TCP
TargetPort:               80/TCP
NodePort:                 &lt;unset&gt;  30737/TCP
Endpoints:                172.17.0.5:80
Session Affinity:         None
External Traffic Policy:  Cluster
Events:                   &lt;none&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Pasamos el nombre de nuestro servicio como parámetro</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Etiqueta añadida de forma predeterminada</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si ahora consultamos la información del pod de la aplicación veremos que coincide la etiqueta. Recordemos que al introducir el concepto de Servicio se indicó que era una abstracción para agrupar pods y que utilizaba etiquetas para poder reunirlos. He aquí la correspondencia entre la etiqueta del servicio y la etiqueta de los pods del servicio.</p>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl get pods <i class="conum" data-value="1"></i><b>(1)</b>

NAME                            READY   STATUS    RESTARTS   AGE
jsonproducer-7769d76894-2nzt2   1/1     Running   0          49m

$ kubectl describe pods jsonproducer-7769d76894-2nzt2 <i class="conum" data-value="2"></i><b>(2)</b>

Name:               jsonproducer-7769d76894-2nzt2
Namespace:          default
Priority:           0
PriorityClassName:  &lt;none&gt;
Node:               minikube/10.0.2.15
Start Time:         Mon, 15 Jul 2019 18:56:20 +0200
Labels:             pod-template-hash=7769d76894
                    run=jsonproducer <i class="conum" data-value="3"></i><b>(3)</b>
Annotations:        &lt;none&gt;
Status:             Running
IP:                 172.17.0.5
Controlled By:      ReplicaSet/jsonproducer-7769d76894 <i class="conum" data-value="4"></i><b>(4)</b>
Containers:
  jsonproducer:
    Container ID:   docker://52e290262984a94da4dd89102b93d80f59c0c4310c303dac67b02884d73fb545
    Image:          ualmtorres/jsonproducer:v0 <i class="conum" data-value="5"></i><b>(5)</b>
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Obtener primero los pods disponibles para poder acceder al pod deseado</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Obtener información del pod</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Etiqueta coincidente con el selector (etiqueta) del Deployment</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>ReplicaSet encargado de mantener el número de pods deseados para el Deployment</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Imagen base usada para crear el único contenedor de este pod</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truevol-menes"><a class="anchor" href="#truevol-menes"></a>5.5. Volúmenes</h3>
<div class="paragraph">
<p>Básicamente, uno volumen es un directorio para datos que es accesible a los contenedores de un Pod y que persiste a los reinicios de un Pod. El medio que se use para el almacenamiento y cómo se comporte ante una eliminación del Pod depende del tipo de volumen que se use.</p>
</div>
<div class="paragraph">
<p>Para usar un volumen, un Pod especifica el volumen que proporciona al Pod (el campo <code>.spec.volumes</code>) y donde montarlo en los contenedores (el campo <code>.spec.containers.volumeMounts</code>).</p>
</div>
</div>
<div class="sect2">
<h3 id="truenamespaces"><a class="anchor" href="#truenamespaces"></a>5.6. Namespaces</h3>
<div class="paragraph">
<p>Abstracción de Kubernetes para soportar varios clusters virtuales en un mismo cluster físico. Los namspaces se usan para organizar objetos en un cluster y para proporcionar una forma de dividir los recursos del cluster. Los nombres de los recursos tienen que ser únicos a nivel de namespace, pero no a nivel de cluster.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>En clusters con varios usuarios los namespaces proporcionan una forma de agrupar los recursos de cada usuario. Además, los administradores pueden establecer cuotas a nivel de namespace limitando a los usuarios la cantidad de objetos que pueden crear y la cantidad de recursos del cluster que pueden consumir (p.e. CPU, memoria).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueescalado-de-una-aplicaci-n"><a class="anchor" href="#trueescalado-de-una-aplicaci-n"></a>6. Escalado de una aplicación</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hasta ahora hemos creado un Deployment que posteriomente ha sido expuesto mediante un Servicio. Como no indicamos número de réplicas, el Deployment creó sólo un Pod para ejecutar la aplicación. Si la demanda aumenta quizá puede llegar a ser necesario aumentar el número de pods de la aplicación. Esto es lo que se conoce como escalado y hace referencia al número de réplicas en un Deployment.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Para escalar un Deployment durante la creación se usa el parámetro <code>--replicas=&lt;numero-de-replicas&gt;</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Al escalar una aplicación se crearán nuevos pods en los nodos con recursos disponibles e irá aumentando hasta llegar al número de pods deseados. La ejecución de varias instancias trae consigo la distribución del tráfico entre todos los pods del Deployment. De esta tarea se encarga un balanceador de carga que integra el propio Servicio.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Escalar a 0 terminará todos los pods de un Deployment.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Una vez que entramos en la dinámica de tener varias instancias de la misma aplicación, se pueden tener actualizaciones en caliente (<em>rolling updates</em>) sin suspensión del servicio. Esto lo veremos en la sección <a href="#trueactualizaci-n-de-aplicaciones">Actualización de aplicaciones</a>.</p>
</div>
<div class="sect2">
<h3 id="trueejemplo-de-escalado-de-una-aplicaci-n"><a class="anchor" href="#trueejemplo-de-escalado-de-una-aplicaci-n"></a>6.1. Ejemplo de escalado de una aplicación</h3>
<div class="paragraph">
<p>En primer lugar veremos cuáles eran las condiciones del despliegue de ejemplo que estamos usando.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl get deployments

NAME           READY   UP-TO-DATE   AVAILABLE   AGE
jsonproducer   1/1     1            1           68m</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>READY</code> indica el ratio entre los pods deseados y los que están en ejecución.</p>
</li>
<li>
<p><code>UP-TO-DATE</code> indica el número de réplicas que están actualizadas para alcanzar el estado deseado.</p>
</li>
<li>
<p><code>AVAILABLE</code> indica el número de réplicas disponibles actualmente para los usuarios.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>El comando siguiente escala a 4 réplicas el despliegue de ejemplo (<code>jsonproducer</code>)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl scale deployments jsonproducer --replicas=4

deployment.extensions/jsonproducer scaled</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unos instantes después podremos comprobar que el Deployment ya ha alcanzado el estado deseado.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl get deployments

NAME           READY   UP-TO-DATE   AVAILABLE   AGE
jsonproducer   4/4     4            4           73m</code></pre>
</div>
</div>
<div class="paragraph">
<p>La aplicación sigue disponible sin ningún cambio para el usuario final. Sin embargo, ahora hay 4 réplicas cuyo tráfico es gestionado por un balanceador de carga asociado al servicio.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/KubernetesRunningService.png" alt="KubernetesRunningService.png">
</div>
</div>
<div class="paragraph">
<p>La información de las réplicas la podemos obtener consultando el número de pods con el comando siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl get pods

NAME                            READY   STATUS    RESTARTS   AGE
jsonproducer-7769d76894-2nzt2   1/1     Running   0          74m
jsonproducer-7769d76894-9xdqw   1/1     Running   0          38s
jsonproducer-7769d76894-nhtl4   1/1     Running   0          38s
jsonproducer-7769d76894-qbvzd   1/1     Running   0          38s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Si ahora por cualquier motivo dejase de estar disponible alguno de los nodos en los que se encuentra desplegados los pods de la apliación, o bien dejase de funcionar alguno de los pods, el Controlador de Deployment de Kubernetes se encargaría de organizar la creación de nuevos pods para volver a alcanzar el estado deseado, en nuestro caso 4 réplicas.</p>
</div>
<div class="paragraph">
<p>Probemos esta funcionalidad eliminando el último pod y comprobando como Kubernetes organiza inmediatamente la creación de otro pod que lo sustituya.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl delete pods jsonproducer-7769d76894-qbvzd
pod "jsonproducer-7769d76894-qbvzd" deleted

$ kubectl get pods
NAME                            READY   STATUS    RESTARTS   AGE
jsonproducer-7769d76894-2nzt2   1/1     Running   0          85m
jsonproducer-7769d76894-9xdqw   1/1     Running   0          12m
jsonproducer-7769d76894-gh7qk   1/1     Running   0          3s <i class="conum" data-value="1"></i><b>(1)</b>
jsonproducer-7769d76894-nhtl4   1/1     Running   0          12m</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Pod que sustituye al pod eliminado creado automáticamente para mantener el número de réplicas a 4</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Por último, si ahora queremos reducir el número de réplicas a 2 bastará con volver a indicarlo al Deployment en el parámetro <code>replicas</code> y este será el nuevo estado a alcanzar.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl scale deployments jsonproducer --replicas=2
deployment.extensions/jsonproducer scaled

$ kubectl get pods
NAME                            READY   STATUS    RESTARTS   AGE
jsonproducer-7769d76894-2nzt2   1/1     Running   0          92m
jsonproducer-7769d76894-9xdqw   1/1     Running   0          18m</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueactualizaci-n-de-aplicaciones"><a class="anchor" href="#trueactualizaci-n-de-aplicaciones"></a>7. Actualización de aplicaciones</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Para poder realizar actualizaciones sin tener que suspender el servicio mientras se realiza la actualización, Kubernetes proporciona las <em>rolling updates</em>, que van actualizando los pods con la nueva versión de la aplicación.</p>
</div>
<div class="paragraph">
<p>De forma predeterminada, el número de pods que pueden estar no disponibles durante una actualización es 1, aunque esta opción es configurable, ya sea mediante cantidad o porcentaje de pods no disponibles durante la actualización. Además, es posible volver a una versión anterior.</p>
</div>
<div class="paragraph">
<p>Al igual que ocurre al escalar las aplicaciones, si el Despliegue está expuesto, el Servicio balancerá el tráfico sólo a los pods que estén disponibles durante la actualización.</p>
</div>
<div class="paragraph">
<p>A continuación se muestra cómo actualizar el Deployment de ejemplo <code>jsonproducer</code> con nuevo Deployment con el mismo nombre y una versión de la imagen.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl set image deployments jsonproducer jsonproducer=ualmtorres/jsonproducer:v1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Al realizar la actualización de la imagen del Deployment, Kubernetes tendrá que descargar la nueva imagen y organizar la creación de los pods en los nodos con recursos disponibles. Mientras se realiza la actualización podremos ver que hay nodos que se están terminando, otros que se están creando y otros que están disponibles.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl get pods
NAME                            READY   STATUS              RESTARTS   AGE
jsonproducer-7769d76894-fr7cz   1/1     Running             0          25s
jsonproducer-7769d76894-hfpr7   1/1     Terminating         0          24s
jsonproducer-c76c87f-jwhxq      0/1     ContainerCreating   0          0s
jsonproducer-c76c87f-tmbkk      1/1     Running             0          1s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tras unos instantes, la aplicación dejará de servir la versión anterior de la aplicación y comenzará a servir la nueva versión. La nueva versión de la aplicación sirve <code>Manolo Torres</code> en lugar de <code>manolo</code> en el JSON.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/KubernetesUpdateImage.png" alt="KubernetesUpdateImage.png">
</div>
</div>
<div class="paragraph">
<p>Para deshacer una actualización de una aplicación volviendo a la versión anterior haremos un <code>rollout undo</code>. El comando siguiente devuelve a la aplicación a la versión anterior</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl rollout undo deployments jsonproducer
deployment.extensions/jsonproducer rolled back</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tras este comando, el Controlador de Deployment de Kubernetes irá reemplanzando los pods hasta alcanzar el estado deseado. A continuación se ve el estado intermedio mientras se vuelve a la versión anterior.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl get pods
NAME                            READY   STATUS        RESTARTS   AGE
jsonproducer-7769d76894-m22sv   1/1     Running       0          2s
jsonproducer-7769d76894-v6hfv   1/1     Running       0          4s
jsonproducer-c76c87f-jwhxq      0/1     Terminating   0          14m
jsonproducer-c76c87f-tmbkk      0/1     Terminating   0          14m</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tras unos instantes, se alcanzará el estado deseado</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">Caligari:~ manolo$ kubectl get pods
NAME                            READY   STATUS    RESTARTS   AGE
jsonproducer-7769d76894-m22sv   1/1     Running   0          8s
jsonproducer-7769d76894-v6hfv   1/1     Running   0          10s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Y la aplicación volverá a mostrar el contenido anterior.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/KubernetesRunningService.png" alt="KubernetesRunningService.png">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truedespliegue-de-aplicaciones-mediante-archivos-yaml"><a class="anchor" href="#truedespliegue-de-aplicaciones-mediante-archivos-yaml"></a>8. Despliegue de aplicaciones mediante archivos YAML</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hasta ahora, las interacción con Kubernetes la hemos hecho sobre la marcha, creando despliegues, servicios, escalado de aplicaciones y demás. Sin embargo, esta no es la forma habitual. Esta forma de uso de Kubernetes está más orientada a la creación de tareas puntuales. En cambio, cuando se trata de operaciones que queremos que sean repetibles, se suelen crear archivos YAML especificando el objeto que se quiere crear en Kubernetes (espacio de nombres, despliegue, servicio, &#8230;&#8203;). Una vez creados estos archivos, se usará <code>kubectl</code> para cargarlos/desplegarlos en Kubernetes.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>El uso de archivos para despliegues Kubernetes nos permitirá admeás someter nuestros archivos de despligue de recursos Kubernetes a control de versiones y poder distribuirlos fácilmente.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para ilustrar el despliegue de una aplicación mediante archivos YAML vamos a desplegar una aplicación de ejemplo que consuma del servicio <code>jsonproducer</code> creado anteriormente. Se trata de un ejemplo muy sencillo de un entorno frontend-backend con un funcionamiento independiente. Esto, además de desacoplar la presentación del backend, desde el punto de vista de la escalabilidad, permite escaladar backend y frontend de forma independiente.</p>
</div>
<div class="sect2">
<h3 id="truecreaci-n-del-archivo-de-deployment"><a class="anchor" href="#truecreaci-n-del-archivo-de-deployment"></a>8.1. Creación del archivo de Deployment</h3>
<div class="paragraph">
<p>Un archivo de Deployment proporciona una forma declarativa de creación de Pods y ReplicaSets. En el archivo de Deployment se especifica el estado deseado.</p>
</div>
<div class="paragraph">
<p>Vamos a crear un archivo de Deployment denominado <code>json-reader-deployment.yaml</code>. Este archivo básicamente contiene entre otros el nombre de despliegue, la etiqueta usada para agrupar los pods del servicio, número de réplicas y la imagen usada para crear el contenedor de cada pod.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">apiVersion: apps/v1
kind: Deployment <i class="conum" data-value="1"></i><b>(1)</b>
metadata:
  name: jsonreader <i class="conum" data-value="2"></i><b>(2)</b>
  namespace: default <i class="conum" data-value="3"></i><b>(3)</b>
  labels:
    app: jsonreader <i class="conum" data-value="4"></i><b>(4)</b>
spec:
  revisionHistoryLimit: 2 <i class="conum" data-value="5"></i><b>(5)</b>
  strategy:
    type: RollingUpdate <i class="conum" data-value="6"></i><b>(6)</b>
  replicas: 2 <i class="conum" data-value="7"></i><b>(7)</b>
  selector:
    matchLabels:
      app: jsonreader <i class="conum" data-value="8"></i><b>(8)</b>
  template:
    metadata:
      labels:
        app: jsonreader
    spec:
      containers:
      - name: jsonreader <i class="conum" data-value="9"></i><b>(9)</b>
        image: ualmtorres/jsonreader:latest <i class="conum" data-value="10"></i><b>(10)</b>
        ports:
        - name: http
          containerPort: 80 <i class="conum" data-value="11"></i><b>(11)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Tipo de recurso a desplegar</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Nombre del despliegue</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Namespace de despliegue</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Selector usado para agrupar a los pods del servicio asociado</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Número de versiones almacenadas para poder deshacer despliegues fallidos</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Tipo de estrategia de actualización</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Número de réplicas del despliegue</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Selector que define cómo el Deployment encuentra los Pods a gestionar, <strong>que coincide con el definido en la plantilla (template) del pod</strong></td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Prefijo usado para los pods</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Imagen base para los contenedores de la aplicación</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>Puerto por el que la aplicación sirve originalmente sus datos</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>La estrategia de despliegue (<code>spec.strategy.type</code>) puede ser <code>Recreate</code> o <code>RollingUpdate</code>, que es el valor predeterminado.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El despliegue se realiza con <code>kubectl</code> con el comando siguiente</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl apply -f json-reader-deployment.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Al crear el despliegue, se procederá a descargar la imagen y se pasarán a crear los dos pods indicados para este despliegue. Podemos ver los pods creados con el comando siguiente comprobando que efectivamente se creado los dos pods <code>jsonreader</code> que exigía el despliegue.</p>
</div>
<div class="paragraph">
<p>Podemos ver el despliegue con el comando siguiente</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl get deployments
NAME           READY   UP-TO-DATE   AVAILABLE   AGE
jsonproducer   1/1     1            1           22h
jsonreader     2/2     2            2           21h</code></pre>
</div>
</div>
<div class="paragraph">
<p>También podemos ver los ReplicaSets creados por los despliegues</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl get rs
NAME                      DESIRED   CURRENT   READY   AGE
jsonproducer-7769d76894   1         1         1       22h
jsonreader-86699d9f94     2         2         2       22h</code></pre>
</div>
</div>
<div class="paragraph">
<p>Los pods los podemos ver junto con sus etiquetas con el parámetro <code>--show-labels</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl get pods --show-labels
NAME                            READY   STATUS    RESTARTS   AGE   LABELS
jsonproducer-7769d76894-ss5qh   1/1     Running   1          22h   pod-template-hash=7769d76894,run=jsonproducer
jsonreader-86699d9f94-khfzh     1/1     Running   1          22h   app=jsonreader,pod-template-hash=86699d9f94
jsonreader-86699d9f94-lrvpt     1/1     Running   1          22h   app=jsonreader,pod-template-hash=86699d9f94</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truecreaci-n-del-archivo-de-servicio"><a class="anchor" href="#truecreaci-n-del-archivo-de-servicio"></a>8.2. Creación del archivo de Servicio</h3>
<div class="paragraph">
<p>Un Servicio es una abstracción que define una agrupación de Pods y una política de acceso a ellos. El conjunto de Pods al que se dirige un Servicio están determinados por un <strong>selector</strong>.</p>
</div>
<div class="paragraph">
<p>Vamos a crear un archivo de Servicio denominado <code>json-reader-service.yaml</code>. Este archivo básicamente contiene entre otros el nombre de servicio, el tipo del servicio (ClusterIP, NodePort, &#8230;&#8203;), el puerto de acceso a los pods del desplieguw y el selector que identifica al despliegue con el que se corresponde el servicio creado.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Service <i class="conum" data-value="1"></i><b>(1)</b>
metadata:
  name: jsonreader <i class="conum" data-value="2"></i><b>(2)</b>
  namespace: default <i class="conum" data-value="3"></i><b>(3)</b>
spec:
  type: NodePort <i class="conum" data-value="4"></i><b>(4)</b>
  ports:
  - name: http
    port: 80 <i class="conum" data-value="5"></i><b>(5)</b>
    targetPort: http
  selector:
    app: jsonreader <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Tipo de recurso a desplegar</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Nombre del servicio</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Namespace de despliegue</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Tipo de servivio. NodePort hará que el servicio esté disponible en la IP de los nodos en los que estén los pods y un puerto aleatorio entre 30000 y 32767</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Puerto en el que los pods están sirviendo su contenido</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Etiqueta que tiene que coincidir con la usada en el Deployment</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El despliegue se realiza con <code>kubectl</code> con el comando siguiente</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl create -f json-reader-service.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>El despliegue nos permitirá acceder a la aplicación en un puerto en el rango 30000-32767. En este caso ha tocado el 31976</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl get services
NAME           TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE
jsonproducer   NodePort    10.105.30.95   &lt;none&gt;        80:30228/TCP   22h
jsonreader     NodePort    10.99.85.2     &lt;none&gt;        80:31976/TCP   22h
kubernetes     ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP        22h</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para poder acceder al servicio pediremos a Minikube que nos lo muestre.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ minikube service jsonreader</code></pre>
</div>
</div>
<div class="paragraph">
<p>Esto hará que se abra un navegador con la aplicación <code>jsonreader</code> que simplemente lee el JSON y presenta un saludo sencillo.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/KubernetesServiceReader.png" alt="KubernetesServiceReader.png">
</div>
</div>
<div class="paragraph">
<p>También podemos usar el Kubernetes Dashboard para mostrar información de interés sobre este despliegue, viendo como de Deployment de <code>jsonreader</code> se ha incorporado a la lista de despliegues disponibles en el cluster, así como los pods, ReplicaSets y servicios, como muestran las figuras siguientes.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/KubernetesDashboardJSON1.png" alt="KubernetesDashboardJSON1.png">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/KubernetesDashboardJSON2.png" alt="KubernetesDashboardJSON2.png">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueap-ndice-cheat-sheet"><a class="anchor" href="#trueap-ndice-cheat-sheet"></a>9. Apéndice. Cheat Sheet</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="truecomandos-minikube"><a class="anchor" href="#truecomandos-minikube"></a>9.1. Comandos Minikube</h3>
<div class="ulist">
<ul>
<li>
<p><code>minikube version</code></p>
</li>
<li>
<p><code>minikube start</code></p>
</li>
<li>
<p><code>minikube dashboard</code></p>
</li>
<li>
<p><code>minikube service &lt;nombre-servicio&gt;</code></p>
</li>
<li>
<p><code>minikube delete</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="truecomandos-code-kubectl-code"><a class="anchor" href="#truecomandos-code-kubectl-code"></a>9.2. Comandos <code>kubectl</code></h3>
<div class="ulist">
<ul>
<li>
<p><code>kubectl version</code></p>
</li>
<li>
<p><code>kubectl cluster-info</code></p>
</li>
<li>
<p><code>kubectl get nodes|deployments|services|pods [--show-labels]</code></p>
</li>
<li>
<p><code>kubectl run &lt;deployment&gt; --image=&lt;image&gt; --port=&lt;container-port&gt;</code></p>
</li>
<li>
<p><code>kubectl expose deployment &lt;deployment&gt;&gt; --type=NodePort</code></p>
</li>
<li>
<p><code>kubectl describe pods|deployments|services &lt;resource&gt;</code></p>
</li>
<li>
<p><code>kubectl scale deployments &lt;deployment&gt; --replicas=&lt;number-of-replicas&gt;</code></p>
</li>
<li>
<p><code>kubectl delete pods|deployments|services &lt;resource&gt;</code></p>
</li>
<li>
<p><code>kubectl set image deployments &lt;deployment&gt; &lt;deployment&gt;=&lt;image&gt;</code></p>
</li>
<li>
<p><code>kubectl rollout undo deployments &lt;deployment&gt;</code></p>
</li>
<li>
<p><code>kubectl apply -f &lt;filename-or-URL&gt;</code></p>
</li>
<li>
<p><code>kubectl logs &lt;pod&gt;</code></p>
</li>
<li>
<p><code>kubectl exec &lt;pod&gt; &lt;command&gt;</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>cloud_provider:
  name: "openstack"
  openstackCloudProvider:
    block_storage:
      ignore-volume-az: true
      trust-device-path: false
    global:
      auth-url: "http://192.168.64.12:5000/v3/"
      domain-name: "default"
      tenant-name: "mtorres"
      username: "mtorres"
      password: "xxx"
    load_balancer:
      create-monitor: false
      manage-security-groups: false
      monitor-max-retries: 0
      use-octavia: false
    metadata:
      request-timeout: 0</p>
</div>
</div>
<div class="sect2">
<h3 id="truecontextos"><a class="anchor" href="#truecontextos"></a>9.3. Contextos</h3>
<div class="paragraph">
<p>El archivo de contextos</p>
</div>
<div class="paragraph">
<p>Disponible en <code>~/.kube/config</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">apiVersion: v1
clusters:
- cluster:
    certificate-authority: /Users/manolo/.minikube/ca.crt
    server: https://192.168.99.100:8443
  name: minikube
contexts:
- context:
    cluster: minikube
    user: minikube
  name: minikube
current-context: ""
kind: Config
preferences: {}
users:
- name: minikube
  user:
    client-certificate: /Users/manolo/.minikube/client.crt
    client-key: /Users/manolo/.minikube/client.key</code></pre>
</div>
</div>
<div class="paragraph">
<p>Obtener los contextos</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl config get-contexts
CURRENT   NAME            CLUSTER         AUTHINFO     NAMESPACE
          minikube        minikube        minikube</code></pre>
</div>
</div>
<div class="paragraph">
<p>Añadir un contexto nuevo</p>
</div>
<div class="paragraph">
<p>Obtener los datos de conexión a Rancher desde</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/RancherKubeconfig.png" alt="RancherKubeconfig.png">
</div>
</div>
<div class="paragraph">
<p>Ahí aparecen los datos de conexión al cluster. Ahí se encuentran los datos que tenemos que copiar en el archivo <code>~/.kube/config</code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/KubeconfigCluster.png" alt="KubeconfigCluster.png">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/KubeconfigUser.png" alt="KubeconfigUser.png">
</div>
</div>
<div class="paragraph">
<p>Editamos el archivo el archivo <code>~/.kube/config</code> y debería quedar algo así</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">apiVersion: v1
clusters:
- cluster:
    certificate-authority: /Users/manolo/.minikube/ca.crt
    server: https://192.168.99.100:8443
  name: minikube
- cluster: <i class="conum" data-value="1"></i><b>(1)</b>
    certificate-authority-data: XXXXXXXXXXXXXXXXXXX
  name: produccion-ci
contexts:
- context:
    cluster: minikube
    user: minikube
  name: minikube
- context: <i class="conum" data-value="2"></i><b>(2)</b>
    cluster: produccion-ci
    namespace: mtorres
    user: user-XXXXXX
  name: produccion-ci
current-context: ""
kind: Config
preferences: {}
users:
- name: minikube
  user:
    client-certificate: /Users/manolo/.minikube/client.crt
    client-key: /Users/manolo/.minikube/client.key
- name: user-XXXXX <i class="conum" data-value="3"></i><b>(3)</b>
  user:
    token: XXXXXXXXXXXXXXXXXXXXX</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Datos del cluster de Rancher</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Datos del nuevo contexto</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Datos del usuario</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Usar un contexto</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl config use-context produccion-ci

Switched to context "produccion-ci".</code></pre>
</div>
</div>
<div class="paragraph">
<p>Si ahora consultamos los contextos, veremos que el contexto activo es <code>produccion-ci</code>. Por tanto, todas las operaciones que hagamos con <code>kubectl</code> a partir de ahora se dirigirán contra ese contexto (cluster-usuario-namespace).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl config get-contexts
CURRENT   NAME            CLUSTER         AUTHINFO     NAMESPACE
          minikube        minikube        minikube
*         produccion-ci   produccion-ci   user-mzmh8   mtorres</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueap-ndice-service-mesh-con-istio"><a class="anchor" href="#trueap-ndice-service-mesh-con-istio"></a>10. Apéndice. Service Mesh con Istio</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Los microservicios se han convertido en algo habitual en las aplicaciones cloud actuales. Las arquitecturas de microservicios permiten realizar cambios en un servicio sin tener que volver a desplegar toda la aplicación. A diferencia de otras arquitecturas, los microservicios pueden ser creados por grupos de desarrollo pequeños creando sus propias herramientas y lenguajes de programación. Básicamente, los microservicios se construyen de forma independiente, se comunican entre sí y pueden fallar de forma individual sin provocar una caída del funcionamiento de la aplicación completa.</p>
</div>
<div class="paragraph">
<p>Sin embargo, el desarrollo y la utilización de microservicios supone nuevos desafíos e implica el desarrollo y gestión de comunicación entre servicios. Esta lógica podría ser codificada en cada servicio sin necesidad de un <em>service mesh</em>, pero a medida que la complejidad crece, se hace más necesario un <em>service mesh</em>.</p>
</div>
<div class="paragraph">
<p>Un <em>service mesh</em> es una capa complementaria responsable de la gestión del tráfico, políticas, certificados y seguridad de los servicios. Así, un <em>service mesh</em> no añade nueva funcionalidad a las aplicaciones. Simplemente, se dedica a sacar fuera de los servicios la lógica de comunicación y la abstrae a una capa de infraestructura. Con un <em>service mesh</em> los desarrolladores pueden centrarse en el desarrollo de la lógica de negocio y abstraerse de lo demás.</p>
</div>
<div class="paragraph">
<p>Para ofrecer esta funcionalidad, un <em>service mesh</em> introduce una colección de proxies de red. En un <em>service mesh</em> las peticiones entre los servicios se enrutan a través de los proxies en su propio nivel de infraestructura. Estos proxies son implementados como sidecars que se situan en el mismo pod que el servicio al que <em>sirven</em> (tráfico, seguridad, &#8230;&#8203;). Si vemos esta red de sidecars desacoplados de los servicios y los situamos en una capa aparte visualizaremos el <em>service mesh</em>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ServiceMesh.png" alt="ServiceMesh.png">
</div>
</div>
<div class="paragraph">
<p>La idea entonces es inyectar un contenedor sidecar especial en cada microservicio y enrutar todo el tráfico a través de los sidecars en lugar de a través de los microservicios. El controlador del <em>service mesh</em> podrá filtrar tráfico, y aplicar políticas de balanceo, seguridad y limitación de tráfico.</p>
</div>
<div class="paragraph">
<p>Sin un <em>service mesh</em>, cada microservicio debería incluir la lógica de gobierno y comunicación con otros servicios, lo que añade una complejidad extra al desarrollo del servicio. Además, el disponer de un <em>service mesh</em> en entornos normalizados, permite tratar el problema del tráfico, políticas, seguridad y certificados entre servicios de forma estándar, independientemente de la plataforma en la que estén desplegadas nuestras aplicaciones.</p>
</div>
<div class="paragraph">
<p><a href="https://istio.io/">Istio</a> es un <em>service mesh</em> que permite conectar, asegurar, controlar y observar servicios.</p>
</div>
<div class="paragraph">
<p><a href="https://www.kiali.io/">Kiali</a> extiende estas características de gestión del tráfico incorporando observabilidad y visualización de servicios de la red para mejorar el trabajo con la red. Kiali ofrece una forma sencilla de ver la toplogía de un <em>service mesh</em> y observar cómo interactúan los servicios.</p>
</div>
<div class="paragraph">
<p><a href="https://www.jaegertracing.io">Jaeger</a> se encarga del tracing y permite a los desarrolladores fragmentar una petición y ver cómo va avanzando entre los distintos servicios de princicio a fin.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ServiceMeshKialiJaeger.png" alt="ServiceMeshKialiJaeger.png">
</div>
</div>
<div class="sect2">
<h3 id="trueistio"><a class="anchor" href="#trueistio"></a>10.1. Istio</h3>
<div class="paragraph">
<p>Istio viene a incorporarse al vocabulario marinero y ballenero del ecosistema de Docker y Kubernetes. Istio es una palabra griega que significa <em>navegar</em>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Istio está disponible en Rancher desde la versión 2.3.0-alpha5. Basta activarlo en el menú <code>Tools</code>. Pedirá si se quiere realizar la inyección automática de sidecars en un <em>namespace</em>. Esto hará que se cree un sidecar en cada pod del <em>namespace</em> para el <code>Istio-proxy</code>. <strong>Este proxy intercepta todo el tráfico al microservicio del pod y asumirá la gestión del enrutado, la selección de versiones, el registro de actividad y tráfico, y el control de acceso</strong>. Por tanto, en cada <em>namespace</em> en el que quede activado Istio se tendrá configurada la etiqueta <code>istio-injection=enabled</code>. No obstante, también es posible activarlo de forma manual, lo que exigiría un reinicio de los servicios, despliegues y otros objetos Kubernetes para que se active el funcionamiento de Istio.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La figura siguiente ilustra una aplicación sin Istio. En ella cada microservicio es el responsable de implementar la funcionalidad de discovery, balanceo, resilencia, métricas y trazado.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/beforeIstio.jpg" alt="beforeIstio.jpg">
</div>
</div>
<div class="paragraph">
<p>La figura siguiente ilustra como en as aplicaciones basadas en Istio los pods están formados por dos contenedores: el contenedor del microservicio y el sidecar. En el sidecar se delegan las tareas de discovery, balanceo, resilencia, métricas y trazado, lo que facilita el desarrollo de los microservicios.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/afterIstio.jpg" alt="afterIstio.jpg">
</div>
</div>
<div class="paragraph">
<p>Istio ofrece una forma declarativa, mediante la creación de manifiestos YAML, de gestión del tráfico, enrutado selectivo de peticiones (en lugar del round robin que ofrece Kubernetes), despliegues (<em>canary, A/B, blue/green</em>), resilencia a nivel de red (con opciones de <em>retry</em>, <em>timeout</em>), control de acceso, observación de microservicios distribuidos comprendiendo los flujos y trazas y pudiendo ver las métricas importantes de forma inmediata, inyección de caos para poner a prueba la resilencia de aplicaciones y servicios, por citar algunas de sus funcionalidades destacadas.</p>
</div>
<div class="paragraph">
<p>Para activar el uso de Istio en un namespace se haría con</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">`kubectl label namespace default istio-injection=enabled`</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truearquitectura-de-istio"><a class="anchor" href="#truearquitectura-de-istio"></a>10.2. Arquitectura de Istio</h3>
<div class="paragraph">
<p>Instio consta de un plano de control y un plano de datos. El plano de datos está formado por proxies que están en la arqutiectura de la aplicación. Usando el patrón del sidecar, cada instancia de la aplicación tendrá su proxy dedicado a través del cual pasa todo el tráfico antes de llegar a la aplicación. Estos proxies individuales pueden ser configurados individualmente para enrutar, filtrar y aumentar el tráfico según sea necesario.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/istioArchitecture.jpg" alt="istioArchitecture.jpg">
</div>
</div>
<div class="paragraph">
<p>Además, Istio permite realizar deciciones de enrutado en función de las cabeceras HTTP (p.e. tipo de navegador, usuario, &#8230;&#8203;)</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/istioCanary.jpg" alt="istioCanary.jpg">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Algo a tener en cuenta es que los componentes del plano de control son aplicaciones sin estado lo que permitan que puedan escalar horizontalmente. Todos los datos están almacenados en <em>etcd</em> como descricpciones personalizadas de recursos Kubernetes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Sin embrgo, toda esta funcionalidad tiene un coste sobre la infraestructura. Cuando mayor sea el cluster mayor será la carga añadida al sistema. Cada sidecar consume mucha RAM (unos 350Mb). Además, añade una latencia de unos 10 ms a cada petición.</p>
</div>
</div>
<div class="sect2">
<h3 id="truecontrol-de-tr-fico-y-t-cnicas-de-despliegue"><a class="anchor" href="#truecontrol-de-tr-fico-y-t-cnicas-de-despliegue"></a>10.3. Control de tráfico y técnicas de despliegue</h3>
<div class="ulist">
<ul>
<li>
<p>Despliegue <em>canary</em>: Se despliega en producción una nueva versión del código pero sólo se dirige a él una parte del tráfico. Quizá sólo tengan acceso a él clientes de prueba, empleados, usuarios de iOS, etcétera. Una vez desplegado el canario, se monitoriza para comprobar la existencia de excepciones, comportamiento no satisfactorio, bajada del rendimiento, y demás. En cambio, si el canario no muestra indicios de que presente problemas se pueden ir aumentando paulatinamente el tráfico hacia él. Si presenta un comportamiento inaceptable, se puede retirar fácilmente de producción.</p>
</li>
<li>
<p>Control del tráfico: Se pueden especificar reglas de enrutado que controlen el tráfico a un conjunto de pods. En concreto, Istio usa los recursos <code>DestinationRule</code> y <code>VirtualService</code> en forma de manifiestos YAML para describir estas reglas.</p>
<div class="ulist">
<ul>
<li>
<p><code>DestinationRule</code>: Define grupos (<em>subsets</em>) de pods.</p>
</li>
<li>
<p><code>VirtualService</code> dirige el tráfico a un <em>subset</em> basado en porcentajes, cabeceras, direcciones IP, por citar algunas. La selección de pods afectados es similar al modelo de selectores utilizado por Kubernetes para selección basada en etiquetas (<em>labels</em>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Este comportamiento del enrutado no es sólo para el tráfico de entrada externo. Es para toda la comunicación inter-servicio en el <em>service mesh</em>. Así, si hubiese servicios desplegados en Kubernetes, pero que no sean parte del <em>mesh</em> no estaría afectado por estas reglas y se regiría por las reglas de balanceo de Kubernetes (round-robin).</p>
</div>
</li>
<li>
<p><em>Dark launch</em>: Despliegue a producción que no es visible a los clientes. En este caso Istio permite duplicar (<em>mirror</em>) el tráfico a una versión de la aplicación y ver cómo se comporta respecto a la versión del pod en producción. De esta forma se están realizando peticiones en las condiciones de producción al nuevo servicio sin afectar al tráfico de la versión en producción. No obstante, hay que tener una consideración especial con los servicios que traten con datos o estén vinculados a otros servicios, para no introducir duplicados, provocar inconsistencias y otros problemas derivados de la duplicación de peticiones.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="truet-cnicas-de-resilencia"><a class="anchor" href="#truet-cnicas-de-resilencia"></a>10.4. Técnicas de resilencia</h3>
<div class="ulist">
<ul>
<li>
<p><em>Circuit breaker</em>: Determina el número máximo de peticiones que puede soportar un pod. Pasado ese valor no admite más hasta que se recupere.</p>
</li>
<li>
<p><em>Pool ejection</em>: Saca de un nodo a un pod que esté dando fallos creando un nuevo pod que los sustituya en otro nodo.</p>
</li>
<li>
<p><em>Retries</em>: Reenvía la petición a otro pod al encontrar un caso de circuit breaker o pool rejection</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="truecaso-pr-ctico"><a class="anchor" href="#truecaso-pr-ctico"></a>10.5. Caso práctico</h3>
<div class="paragraph">
<p>Para no perdernos en los detalles usaremos un ejemplo muy sencillo con dos servicios: uno que produce datos y otro que los presenta. Podríamos ver este ejemplo como un ejemplo muy reducido de backend y frontend.</p>
</div>
<div class="paragraph">
<p>El servicio que genera datos se denomina <code>jsonproducer</code> y genera un documento JSON con un único elemento <code>nombre</code> y un valor aasociado (p.e. <code>{"nombre": "manolo"}</code>). De este servicio se cuenta con dos versiones, cada una con su imagen Docker correspondiente. La primera versión devuelve el elemento JSON <code>{"nombre": "manolo"}</code>. La segunda versión devuelve el elemento JSON <code>{"nombre": "Manuel Torres"}</code></p>
</div>
<div class="paragraph">
<p>El servicio que consume datos se denomina <code>jsonconsumer</code> y usará los datos leídos de <code>jsonproducer</code> para presentarlos al usuario en forma de saludo, mostrando <code>Hola</code> seguido del nombre leído del JSON devuelto por la versión de <code>jsonproducer</code> usada.</p>
</div>
<div class="sect3">
<h4 id="truecreaci-n-de-todos-los-servicios"><a class="anchor" href="#truecreaci-n-de-todos-los-servicios"></a>10.5.1. Creación de todos los servicios</h4>
<div class="paragraph">
<p>Vamos a desplegar en el cluster de Kubernetes todos los recursos (<code>Service</code> y <code>Deployment</code>) con todas sus versiones correspondientes. Posteriormente, con Istio controlaremos el tráfico que se dirige a cada versión desplegada. En nuestro ejemplo se definirán dos objetos <code>Deployment</code>, uno para cada una de las versiones del <code>jsonproducer</code> que quedarán desplegadas en el cluster.</p>
</div>
<div class="paragraph">
<p>Cada despliegue incorpora en los metadatos el nombre que le que queremos dar, así como unas etiquetas con su versión, que le permitirán ser seleccionado posteriormente cuando se definan los <em>servicios virtuales</em>. Además, en la <code>spec</code> del despliegue se usarán etiquetas en <code>matchLabels</code> que permitirán más adelante a Istio distinguir los pods correspondientes a cada despliegue.</p>
</div>
<div class="paragraph">
<p>En este ejemplo usaremos dos versiones (dos recursos <code>Deployment</code>) del <code>jsonproducer</code>. La primera está basada en la imagen <code>ualmtorres/jsonproducer:v0</code> que devuelve <code>{"nombre": "manolo"}</code>. La segunda está basada en la imagen <code>ualmtorres/jsonproducer:v1</code> que devuelve <code>{"nombre": "Manuel Torres"}</code>. Con este ejemplo tan sencillo nos bastará para ver a Istio en acción controlando el tráfico.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">#########################################################
# jsonproducer service
#########################################################
apiVersion: v1
kind: Service
metadata:
  name: jsonproducer
  labels:
    app: jsonproducer
    service: jsonproducer
spec:
  ports:
  - port: 80
    name: http
  selector:
    app: jsonproducer
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jsonproducer-v0 <i class="conum" data-value="1"></i><b>(1)</b>
  labels:
    app: jsonproducer
    version: v0
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jsonproducer
      version: v0 <i class="conum" data-value="2"></i><b>(2)</b>
  template:
    metadata:
      labels:
        app: jsonproducer
        version: v0
    spec:
      containers:
      - name: jsonproducer
        image: ualmtorres/jsonproducer:v0 <i class="conum" data-value="3"></i><b>(3)</b>
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 80
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jsonproducer-v1 <i class="conum" data-value="4"></i><b>(4)</b>
  labels:
    app: jsonproducer
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jsonproducer
      version: v1 <i class="conum" data-value="5"></i><b>(5)</b>
  template:
    metadata:
      labels:
        app: jsonproducer
        version: v1
    spec:
      containers:
      - name: jsonproducer
        image: ualmtorres/jsonproducer:v1 <i class="conum" data-value="6"></i><b>(6)</b>
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 80
---
###########################################################
# jsonreader services
###########################################################
apiVersion: v1
kind: Service
metadata:
  name: jsonreaderpage
  labels:
    app: jsonreaderpage
    service: jsonreaderpage
spec:
  ports:
  - port: 80
    name: http
  selector:
    app: jsonreaderpage
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jsonreaderpage-v0
  labels:
    app: jsonreaderpage
    version: v0
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jsonreaderpage
      version: v0
  template:
    metadata:
      labels:
        app: jsonreaderpage
        version: v0
    spec:
      containers:
      - name: jsonreaderpage
        image: ualmtorres/jsonreader:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 80
---</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Versión <code>v0</code> del servicio</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Selector para determinar los pods asociados a la versión <code>v0</code> del servicio</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Imagen <code>v0</code> del servicio</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Versión <code>v1</code> del servicio</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Selector para determinar los pods asociados a la versión <code>v1</code> del servicio</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Imagen <code>v1</code> del servicio</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="truecreaci-n-de-los-em-subsets-em-mediante-code-destionationrule-code"><a class="anchor" href="#truecreaci-n-de-los-em-subsets-em-mediante-code-destionationrule-code"></a>10.5.2. Creación de los <em>subsets</em> mediante <code>DestionationRule</code></h4>
<div class="paragraph">
<p>Las <code>DestinatioRule</code> se usan para definir las distintas instancias o versiones disponibles de cada servicio. Cada servicio tendrá su <code>DestinationRule</code> con lo siguiente:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>metatada.name</code>: Nombre.</p>
</li>
<li>
<p><code>spec.host</code>: Host contra el que se lanzará este servicio. Puede ser un nombre DNS (admite <em>wildcards</em>) o un nombre de servicio válido en nuestra aplicación.</p>
</li>
<li>
<p><code>spec.subsets</code>: Lista de versiones de servicios a configurar. Cada versión tendrá su nombre (<code>name</code>) y usará una etiqueta (p.e. <code>labels.version: v0</code>) para emparejarse con los pods de su versión de acuerdo a lo definido en el selector <code>matchLabels</code> del objeto <code>Deployment</code> del manifiesto del apartado anterior.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: jsonreaderpage
spec:
  host: jsonreaderpage
  subsets:
  - name: v0
    labels:
      version: v0
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: jsonproducer
spec:
  host: jsonproducer <i class="conum" data-value="1"></i><b>(1)</b>
  subsets:
  - name: v0
    labels:
      version: v0
  - name: v1 <i class="conum" data-value="2"></i><b>(2)</b>
    labels:
      version: v1 <i class="conum" data-value="3"></i><b>(3)</b>
---</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Nombre que le damos a nuestro host y que luego será usado por los <em>servicios virtuales</em> para dirigir el tráfico a una versión concreta de las definidas en los <code>subsets</code>. Este nombre debe coincidir con los nombres de servicio usados en el código de la aplicación</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Nombre dado a esta versión del servicio</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Etiqueta usada para seleccionar los pods a los que corresponde esta versión. Se emparejarán los pods que tengan <code>version: v1</code> en su <code>MatchingLabels</code></td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="truecreaci-n-de-los-servicios-virtuales-para-el-control-del-tr-fico"><a class="anchor" href="#truecreaci-n-de-los-servicios-virtuales-para-el-control-del-tr-fico"></a>10.5.3. Creación de los servicios virtuales para el control del tráfico</h4>
<div class="paragraph">
<p>Por último, crearemos los <code>VirtualService</code> para indicarle a Istio la versión concreta de cada microservicio desplegado a la que queremos desviar el tráfico. Este recurso es el que Istio usará para configurar los proxies que controlarán el tráfico en el <em>mesh</em>.</p>
</div>
<div class="paragraph">
<p>Con los servicios virtuales conseguimos crear la capa complementaria a la aplicación que controlará su tráfico. Esto nos permite usar y cambiar a versiones concretas, derivar un porcentaje del tráfico a versiones concretas (despliegues <code>canary</code>), tener versiones diferentes para usuarios diferentes, control de tráfico basado en CIDR, y demás.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Con Istio podremos cambiar el enrutado a unos servicios u otros de forma dinánima. Basta con aplicar otro manifiesto con los nuevos valores de enrutado de los <code>VirtualService</code> que seleccionen las versiones correspondientes, el porcentaje de derivación de tráfico entre versiones que coexistan, y demás.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El manifiesto siguiente define un servicio virtual para cada servicio de nuestra aplicación. En este ejemplo cada servicio virtual usa la versión <code>v0</code> de los <code>Deployment</code> desplegados en el cluster.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: jsonreaderpage
spec:
  hosts:
  - jsonreaderpage
  http:
  - route:
    - destination:
        host: jsonreaderpage
        subset: v0
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: jsonproducer
spec:
  hosts:
  - jsonproducer <i class="conum" data-value="1"></i><b>(1)</b>
  http:
  - route:
    - destination:
        host: jsonproducer <i class="conum" data-value="2"></i><b>(2)</b>
        subset: v0 <i class="conum" data-value="3"></i><b>(3)</b>
---</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Nombre DNS (admite prefijos <em>wildcard</em>) o nombres de servicios del <em>mesh</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Servicio al que se quiere dirigir el tráfico</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Versión a la que se quiere dirigir el tráfico</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truecasos-pr-cticos"><a class="anchor" href="#truecasos-pr-cticos"></a>10.6. Casos prácticos</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Instalación del ejemplo</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.2/samples/bookinfo/platform/kube/bookinfo.yaml
$ kubectl get services
$ kubectl get pods
$ kubectl exec -it $(kubectl get pod -l app=ratings -o jsonpath='{.items[0].metadata.name}') -c ratings -- curl productpage:9080/productpage | grep -o "&lt;title&gt;.*&lt;/title&gt;"
$ kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.2/samples/bookinfo/networking/bookinfo-gateway.yaml
$ kubectl get gateway</code></pre>
</div>
</div>
</li>
<li>
<p>Crear el Ingress en Rancher para el servicio <code>productpage</code>.</p>
</li>
<li>
<p>Crear las reglas de acceso predeterminadas para los servicios de la aplicación</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.2/samples/bookinfo/networking/destination-rule-all.yaml
$ kubectl get destinationrules -o yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Archivo <code>destination-rule-all.yaml</code> que permite el tráfico de forma indistinta a cualquier versión de <code>ratings</code>, <code>reviews</code> y <code>details</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: productpage
spec:
  host: productpage
  subsets:
  - name: v1
    labels:
      version: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
  - name: v3
    labels:
      version: v3
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: ratings
spec:
  host: ratings
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
  - name: v2-mysql
    labels:
      version: v2-mysql
  - name: v2-mysql-vm
    labels:
      version: v2-mysql-vm
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: details
spec:
  host: details
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
---</code></pre>
</div>
</div>
<div class="paragraph">
<p>Usar sólo la versión V1 de cada microservicio:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: productpage
spec:
  hosts:
  - productpage
  http:
  - route:
    - destination:
        host: productpage
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: ratings
spec:
  hosts:
  - ratings
  http:
  - route:
    - destination:
        host: ratings
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: details
spec:
  hosts:
  - details
  http:
  - route:
    - destination:
        host: details
        subset: v1
---</code></pre>
</div>
</div>
<div class="paragraph">
<p>Aplicando ahora unas reglas para desviar el tráfico a V2 a los usuarios con sesión iniciada con el usuario <code>jason</code> y a V1 a los que no tienen sesión iniciada.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.2/samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
    - reviews
  http:
  - match:
    - headers:
        end-user:
          exact: jason
    route:
    - destination:
        host: reviews
        subset: v2
  - route:
    - destination:
        host: reviews
        subset: v1</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2019-09-01 08:09:18 CEST
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>